# 9.3 Iteración 2: Identificar estructuras para soportar la funcionalidad primaria



---



\## 1. Revisar Entradas


---



## 2. Objetivo de la Iteración



Definir y ajustar las estructuras necesarias para que el \*\*flujo funcional principal\*\* de SportSync sea completamente operativo de extremo a extremo: desde la \*\*reserva de espacios deportivos\*\*, pasando por la \*\*gestión de pagos premium\*\* con Stripe, hasta la \*\*visualización de datos en el perfil del usuario\*\*. Se prioriza garantizar rendimiento, seguridad, coherencia de datos y usabilidad dentro del flujo real.



---



\## 3. Elementos del Sistema a Refinar



**Módulo de Reservas**

**Módulo de Pagos**

**Módulo de Perfil de Usuario**

**API Gateway Centralizado (NGINX)**
**Integración Stripe (webhooks)**



---



\## 4. Conceptos de Diseño para Satisfacer el Driver



| Código  | Decisión de Diseño                                       | Fundamentación                                                                                                                                                                                                                                                   |
|---------|-----------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| DEC-11  | Implementar puntos de agregación en API Gateway           | NGINX actúa como gateway que agrupa rutas relacionadas y consolida respuestas de múltiples microservicios (reservas, pagos). Esto reduce la cantidad de llamadas del cliente y mejora la eficiencia de comunicación (CRN06).                                   |
| DEC-12  | Mejorar consultas SQL con índices compuestos              | Se añaden índices compuestos en campos frecuentemente consultados (ej. fecha, estado) en PostgreSQL para optimizar tiempos de respuesta al filtrar reservas o listar pagos. Mejora el rendimiento general en operaciones críticas (CRN01).                    |
| DEC-13  | Validación de Webhooks de Stripe                          | Stripe envía eventos de pago al backend mediante webhooks. Estos se validan con firmas secretas para asegurar su autenticidad antes de actualizar el estado de las reservas/pagos, cumpliendo con prácticas de seguridad transaccional (CON10).                |
| DEC-14  | Aplicar Gateway Aggregation Pattern                       | El API Gateway implementa el patrón de agregación para orquestar múltiples llamadas backend (reservas + pagos), entregando al cliente un historial unificado en una sola respuesta. Reduce latencia y simplifica lógica del frontend (CRN06, CU24).           |
| DEC-15  | Protección de endpoints con JWT y RBAC básico             | Se implementa middleware en Express para proteger rutas sensibles (reservas, pagos, perfil) usando autenticación con JWT y control de acceso por roles. Alineado con requisitos de seguridad y privacidad de datos del usuario (CON07, CU01-CU04).              |




---



\## 5. Elementos de Arquitectura, Responsabilidades e Interfaces



| Código | Elemento | Responsabilidad |

|--------|-------------------------------|------------------------------|

| DEC-16 | Módulo de Reservas | Maneja creación, consulta y cancelación de reservas, validando disponibilidad y actualizando estado tras pago. |

| DEC-17 | Módulo de Pagos | Procesa cobros premium con Stripe, registra transacciones y expone endpoints para confirmar estados mediante webhooks. |

| DEC-18 | Perfil de Usuario | Consulta datos agregados de reservas y pagos, expuestos como una sola respuesta a través del Gateway Aggregation. |

| DEC-19 | API Gateway (NGINX) | Centraliza el ruteo REST y aplica el patrón Gateway Aggregation combinando múltiples endpoints backend en una respuesta única para el cliente. |



---



\## 6. Vistas y Bosquejo del Flujo Principal



\*\*Flujo principal implementado:\*\*



1\. El usuario reserva un espacio → el módulo de reservas valida disponibilidad y bloquea la fecha.

2\. El usuario paga la reserva → el módulo de pagos procesa el cobro mediante Stripe.

3\. Stripe confirma el pago → el webhook actualiza el estado de reserva/pago.

4\. El usuario accede a su perfil → el Gateway combina reservas + pagos → el frontend muestra historial completo.



---



\## 7. Revisión de Objetivos



| Elemento   | Estado                 | Decisión de Diseño Aplicada |

|------------|------------------------|------------------------------|

| ESC-06     | Completamente Abordado | DEC-11, DEC-12, DEC-14 |

| ESC-07     | Completamente Abordado | DEC-11, DEC-12, DEC-13 |

| ESC-INT-01 | Completamente Abordado | DEC-11, DEC-14 |

| ESC-INT-03 | Completamente Abordado | DEC-11, DEC-14 |

| ESC-SEC-04 | Completamente Abordado | DEC-15 |

| ESC-PRB-01 | Parcialmente Abordado  | DEC-14 |

| ESC-USA-04 | Completamente Abordado | DEC-11, DEC-12 |



---



\## Resumen de la Iteración 2



Esta segunda iteración ha logrado:



\- Implementar el flujo principal \*\*reserva → pago → confirmación → perfil\*\* de forma funcional y segura.

\- Consolidar la coordinación entre módulos: \*\*reservas\*\*, \*\*pagos\*\* y \*\*perfil de usuario\*\*.

\- Aplicar \*\*Gateway Aggregation Pattern\*\* para exponer datos combinados de forma eficiente.

\- Optimizar el rendimiento mediante \*\*índices SQL\*\* y webhooks Stripe.

\- Fortalecer la seguridad del flujo con JWT y roles básicos.



---



\## Infraestructura Esperada



\- \*\*Frontend React modular\*\* con formularios de reserva y pagos.

\- \*\*Backend Express\*\* organizado por capas.

\- \*\*API Gateway NGINX\*\* centralizado con rutas agregadas.

\- \*\*Base de datos PostgreSQL\*\* única, optimizada con índices y claves foráneas.

\- \*\*Stripe\*\* como procesador de pagos validado con webhooks seguros.



---



\## Funcionalidades Implementadas



\- \*\*Reservas\*\*: creación, cancelación y consulta con filtros.

\- \*\*Pagos\*\*: integración con Stripe, registro y actualización de transacciones.

\- \*\*Perfil\*\*: historial de reservas y pagos consolidado.

\- \*\*Seguridad\*\*: JWT middleware para rutas críticas.

\- \*\*Agregación\*\*: Gateway combina respuestas de múltiples endpoints en una sola llamada REST.



